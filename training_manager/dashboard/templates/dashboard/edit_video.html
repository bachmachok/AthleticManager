{% extends "dashboard/base.html" %}
{% load i18n %}
{% block title %}{% trans "–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –≤—ñ–¥–µ–æ ‚Äî Athletic Manager" %}{% endblock %}

{% block content %}
{% trans "—Å" as UNIT_S %}
{% trans "–º" as UNIT_M %}

<style>
  :root{
    --control-bg:#ffffff; --control-text:#0f172a; --control-border:rgba(15,23,42,.12);
    --control-disabled-bg:#f1f5f9; --control-disabled-text:#64748b;
    --select-arrow:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%235b6b92'%3E%3Cpath fill-rule='evenodd' d='M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.25 8.29a.75.75 0 01-.02-1.08z' clip-rule='evenodd'/%3E%3C/svg%3E");
  }
  .dark{
    --control-bg:rgba(255,255,255,.06); --control-text:#e5e7eb; --control-border:rgba(255,255,255,.18);
    --control-disabled-bg:rgba(255,255,255,.08); --control-disabled-text:#cbd5e1;
    --select-arrow:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%23cbd5e1'%3E%3Cpath fill-rule='evenodd' d='M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.25 8.29a.75.75 0 01-.02-1.08z' clip-rule='evenodd'/%3E%3C/svg%3E");
    color-scheme:dark;
  }

  .form-skin input[type="text"],
  .form-skin input[type="number"],
  .form-skin input[type="time"],
  .form-skin input[type="date"],
  .form-skin input[type="file"],
  .form-skin select,
  .form-skin textarea{
    background:var(--control-bg); color:var(--control-text);
    border:1px solid var(--control-border); border-radius:.625rem; padding:.5rem .625rem;
  }
  .form-skin input[disabled], .form-skin select[disabled], .form-skin textarea[disabled],
  .form-skin input[readonly], .form-skin select[readonly], .form-skin textarea[readonly]{
    background:var(--control-disabled-bg); color:var(--control-disabled-text); border-color:var(--control-border); opacity:1; cursor:not-allowed;
  }
  .form-skin select{appearance:none; padding-right:2.25rem; background-image:var(--select-arrow); background-repeat:no-repeat; background-position:right .6rem center; background-size:16px 16px;}
  .dark .form-skin select option, .dark .form-skin select optgroup{background:#0f172a; color:#e5e7eb;}
  .dark .form-skin select option:checked{background:#1e49ff; color:#fff;}

  .unit-badge{display:inline-block; margin-left:.375rem; padding:.125rem .5rem; font-size:11px; border-radius:999px; background:#eef2ff; color:#1e49ff;}
  .dark .unit-badge{background:rgba(30,73,255,.22); color:#e0e7ff;}

  .visually-hidden-input{
    position:absolute !important; clip:rect(0 0 0 0) !important; clip-path:inset(50%) !important;
    width:1px !important; height:1px !important; padding:0 !important; margin:-1px !important;
    overflow:hidden !important; border:0 !important; white-space:nowrap !important;
  }
</style>

<h1 class="hidden" aria-hidden="true">{% trans "–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –≤—ñ–¥–µ–æ" %}</h1>

<div class="mx-auto w-full max-w-[920px]">
  <article class="card form-skin">
    <header class="px-6 pt-6 pb-3 border-b border-gray-200 dark:border-white/10">
      <h2 class="text-xl md:text-2xl font-semibold flex items-center gap-2">
        üéûÔ∏è {% trans "–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –≤—ñ–¥–µ–æ —Å–ø—Ä–æ–±–∏" %}
      </h2>
    </header>

    <form method="post" enctype="multipart/form-data" novalidate>
      {% csrf_token %}

      {% if form.non_field_errors %}
        <div class="px-6 pt-4">
          <div class="rounded-lg bg-red-50 text-red-700 px-3 py-2 text-sm dark:bg-red-900/20 dark:text-red-300">
            {% for err in form.non_field_errors %}<div>{{ err }}</div>{% endfor %}
          </div>
        </div>
      {% endif %}

      <div class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

          <div>
            <label for="{{ form.category.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">
              {% trans "–ö–∞—Ç–µ–≥–æ—Ä—ñ—è" %} <span class="text-red-600">*</span>
            </label>
            {{ form.category }}
            {% if form.category.errors %}
              <ul class="mt-1 text-xs text-red-600 dark:text-red-400 space-y-0.5">
                {% for err in form.category.errors %}<li>{{ err }}</li>{% endfor %}
              </ul>
            {% endif %}
          </div>

          <div>
            <label for="{{ form.event_type.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">
              {% trans "–î–∏—Å—Ü–∏–ø–ª—ñ–Ω–∞" %} <span class="text-red-600">*</span>
            </label>
            {{ form.event_type }}
            {% if form.event_type.errors %}
              <ul class="mt-1 text-xs text-red-600 dark:text-red-400 space-y-0.5">
                {% for err in form.event_type.errors %}<li>{{ err }}</li>{% endfor %}
              </ul>
            {% endif %}
          </div>

          <div>
            <label for="{{ form.result.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">
              {% trans "–†–µ–∑—É–ª—å—Ç–∞—Ç" %}
              <span id="unit-badge" class="unit-badge" data-unit-s="{{ UNIT_S }}" data-unit-m="{{ UNIT_M }}">‚Äî</span>
            </label>
            {{ form.result }}
            {% if form.result.errors %}
              <ul class="mt-1 text-xs text-red-600 dark:text-red-400 space-y-0.5">
                {% for err in form.result.errors %}<li>{{ err }}</li>{% endfor %}
              </ul>
            {% endif %}
          </div>

          <div>
            <label for="{{ form.attempt_number.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">
              {% trans "–ù–æ–º–µ—Ä —Å–ø—Ä–æ–±–∏" %}
            </label>
            {{ form.attempt_number }}
            {% if form.attempt_number.errors %}
              <ul class="mt-1 text-xs text-red-600 dark:text-red-400 space-y-0.5">
                {% for err in form.attempt_number.errors %}<li>{{ err }}</li>{% endfor %}
              </ul>
            {% endif %}
          </div>

          <div id="pip-wrapper">
            <label for="{{ form.place_in_protocol.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">
              {% trans "–ú—ñ—Å—Ü–µ –≤ –ø—Ä–æ—Ç–æ–∫–æ–ª—ñ" %} <span id="pip-required" class="text-red-600" style="display:none">*</span>
            </label>
            {{ form.place_in_protocol }}
            {% if form.place_in_protocol.errors %}
              <ul class="mt-1 text-xs text-red-600 dark:text-red-400 space-y-0.5">
                {% for err in form.place_in_protocol.errors %}<li>{{ err }}</li>{% endfor %}
              </ul>
            {% endif %}
          </div>

          <div>
            <label for="{{ form.time.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">
              {% trans "–ß–∞—Å —Å–ø—Ä–æ–±–∏" %}
            </label>
            {{ form.time }}
            {% if form.time.errors %}
              <ul class="mt-1 text-xs text-red-600 dark:text-red-400 space-y-0.5">
                {% for err in form.time.errors %}<li>{{ err }}</li>{% endfor %}
              </ul>
            {% endif %}
          </div>

          <div class="md:col-span-2">
            <label for="{{ form.video.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">
              {% trans "–í—ñ–¥–µ–æ" %} <span class="text-red-600">*</span>
            </label>

            <input
              type="file"
              name="{{ form.video.html_name }}"
              id="{{ form.video.id_for_label }}"
              accept="video/*"
              class="visually-hidden-input"
              {% if form.video.field.required %}required{% endif %}
            >

            <div class="flex items-center gap-3">
              <button type="button" id="pick-video-btn" class="btn btn-secondary btn-sm">
                {% trans "–û–±—Ä–∞—Ç–∏ —Ñ–∞–π–ª" %}
              </button>

              <span id="picked-video-name"
                    class="text-sm text-gray-600 dark:text-gray-300"
                    data-empty="{% trans '–§–∞–π–ª –Ω–µ –≤–∏–±—Ä–∞–Ω–æ' %}"
                    aria-live="polite">
                {% if form.instance.pk and form.instance.video %}
                  {% trans "–ü–æ—Ç–æ—á–Ω–∏–π —Ñ–∞–π–ª" %}: <a href="{{ form.instance.video.url }}" class="underline" target="_blank" rel="noopener">
                    {{ form.instance.video.name }}
                  </a>
                {% else %}
                  {% trans "–§–∞–π–ª –Ω–µ –≤–∏–±—Ä–∞–Ω–æ" %}
                {% endif %}
              </span>
            </div>

            {% if form.video.errors %}
              <ul class="mt-1 text-xs text-red-600 dark:text-red-400 space-y-0.5">
                {% for err in form.video.errors %}<li>{{ err }}</li>{% endfor %}
              </ul>
            {% endif %}
          </div>

        </div>
      </div>

      <footer class="px-6 pb-6 pt-3 border-t border-gray-200 dark:border-white/10 flex items-center justify-end gap-3">
        <a href="{% url 'upload' %}" class="btn btn-ghost btn-sm">{% trans "–í—ñ–¥–º—ñ–Ω–∏—Ç–∏" %}</a>
        <button type="submit" class="btn btn-primary btn-sm">{% trans "–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏" %}</button>
      </footer>
    </form>
  </article>
</div>

{% if categories_meta %}{{ categories_meta|json_script:"categories-meta" }}{% endif %}

<script>
  (function () {
    // –û–¥–∏–Ω–∏—Ü—ñ ¬´—Å/–º¬ª –±—ñ–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
    const eventSel = document.getElementById('id_event_type');
    const unit = document.getElementById('unit-badge');
    function updateUnit(){
      if (!unit) return;
      const s = unit.dataset.unitS || '—Å';
      const m = unit.dataset.unitM || '–º';
      unit.textContent = (eventSel?.value === 'run') ? s : m;
    }
    eventSel?.addEventListener('change', updateUnit); updateUnit();

    // ¬´–ú—ñ—Å—Ü–µ –≤ –ø—Ä–æ—Ç–æ–∫–æ–ª—ñ¬ª ‚Äî —Ç—ñ–ª—å–∫–∏ –¥–ª—è –∑–º–∞–≥–∞–Ω—å
    const catSel = document.getElementById('id_category');
    const pipWrap = document.getElementById('pip-wrapper');
    const pipInp  = document.getElementById('id_place_in_protocol');
    const pipReq  = document.getElementById('pip-required');

    let typeById = {};
    const meta = document.getElementById('categories-meta');
    if (meta) { try { JSON.parse(meta.textContent).forEach(x => typeById[String(x.id)] = x.attempt_type); } catch (e) {} }

    function togglePip(){
      const isComp = typeById[String(catSel?.value || '')] === 'competition';
      if (pipWrap) pipWrap.style.display = isComp ? '' : 'none';
      if (pipInp)  isComp ? pipInp.setAttribute('required','required') : pipInp.removeAttribute('required');
      if (pipReq)  pipReq.style.display = isComp ? '' : 'none';
    }
    catSel?.addEventListener('change', togglePip); togglePip();

    // –ö–Ω–æ–ø–∫–∞ –≤–∏–±–æ—Ä—É —Ñ–∞–π–ª—É
    const fileInput = document.getElementById('{{ form.video.id_for_label }}');
    const pickBtn   = document.getElementById('pick-video-btn');
    const fileName  = document.getElementById('picked-video-name');
    pickBtn?.addEventListener('click', () => fileInput?.click());
    fileInput?.addEventListener('change', () => {
      if (!fileName) return;
      fileName.textContent = (fileInput.files && fileInput.files.length)
        ? fileInput.files[0].name
        : (fileName.dataset.empty || '');
    });
  })();
</script>
{% endblock %}
