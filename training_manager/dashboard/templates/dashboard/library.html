{# training_manager/dashboard/templates/dashboard/library.html #}
{% extends "dashboard/base.html" %}
{% load i18n %}

{% block title %}{% trans "–ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∞" %} ‚Äî Athletic Manager{% endblock %}

{% block content %}

<style>
  /* ===== Segmented controls (–ø—ñ–≥—É–ª–∫–∏) ===== */
  .seg {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding: 8px;
    border-radius: 12px;
    background: var(--seg-bg, #f8fafc);
  }
  .dark .seg { --seg-bg: rgba(255,255,255,.06); }

  .seg__item {
    position: relative;
    display: inline-flex;
    align-items: center;
    gap: .5rem;
    padding: 10px 14px;
    border-radius: 999px;
    font-size: .9rem;
    font-weight: 600;
    cursor: pointer;
    user-select: none;
    background: #fff;
    border: 1px solid rgba(15,23,42,.08);
    transition: box-shadow .15s ease, transform .06s ease, background .15s ease, color .15s ease;
  }
  .dark .seg__item {
    background: rgba(255,255,255,.04);
    border-color: rgba(255,255,255,.08);
  }
  .seg__item:hover { transform: translateY(-1px); }

  .seg__item input {
    position: absolute;
    inset: 0;
    opacity: 0;
    pointer-events: none;
  }

  .seg__item--active {
    background: #1e49ff;
    color: #fff;
    border-color: transparent;
    box-shadow: 0 6px 18px rgba(30,73,255,.35);
  }

  .seg__icon {
    font-size: 1rem;
    line-height: 1;
  }

  .filters-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 14px;
  }
  @media (min-width: 860px) {
    .filters-grid {
      grid-template-columns: 1fr 2fr auto;
      align-items: center;
    }
  }
</style>

  <h1 class="text-2xl md:text-3xl font-semibold tracking-tight mb-6">üé• {% trans "–ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ –≤—ñ–¥–µ–æ" %}</h1>

  <!-- –§—ñ–ª—å—Ç—Ä–∏ + —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è -->
  <article class="card mb-6">
    <form id="lib-filters" method="get" class="card-body filters-grid">

      {# –¢–∏–ø –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó —è–∫ –ø—ñ–≥—É–ª–∫–∏ #}
      <fieldset>
        <legend class="mb-2 text-sm font-medium text-gray-700 dark:text-gray-200">{% trans "–ö–∞—Ç–µ–≥–æ—Ä—ñ—è" %}</legend>
        <div class="seg" id="seg-type">
          <label class="seg__item {% if not filter_attempt_type %}seg__item--active{% endif %}">
            <span class="seg__icon">‚ú®</span> {% trans "–£—Å—ñ" %}
            <input type="radio" name="attempt_type" value="" {% if not filter_attempt_type %}checked{% endif %}>
          </label>

          {% for val, label in attempt_type_choices %}
            <label class="seg__item {% if filter_attempt_type == val %}seg__item--active{% endif %}">
              {% if val == 'competition' %}<span class="seg__icon">üèÜ</span>{% else %}<span class="seg__icon">üß™</span>{% endif %}
              {{ label }}
              <input type="radio" name="attempt_type" value="{{ val }}" {% if filter_attempt_type == val %}checked{% endif %}>
            </label>
          {% endfor %}
        </div>
      </fieldset>

      {# –°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ–π —è–∫ –ø—ñ–≥—É–ª–∫–∏ (–±–µ–∑ —Ç–∏–ø—É —Ç–∞ –º—ñ—Å—Ü—è) #}
      <fieldset>
        <legend class="mb-2 text-sm font-medium text-gray-700 dark:text-gray-200">{% trans "–°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è" %}</legend>
        <div class="seg" id="seg-sort">
          <label class="seg__item {% if sort == 'date_desc' %}seg__item--active{% endif %}">
            <span class="seg__icon">üÜï</span> {% trans "–î–∞—Ç–∞ (–Ω–æ–≤—ñ—à—ñ)" %}
            <input type="radio" name="sort" value="date_desc" {% if sort == 'date_desc' %}checked{% endif %}>
          </label>
          <label class="seg__item {% if sort == 'date_asc' %}seg__item--active{% endif %}">
            <span class="seg__icon">üìÖ</span> {% trans "–î–∞—Ç–∞ (—Å—Ç–∞—Ä—ñ—à—ñ)" %}
            <input type="radio" name="sort" value="date_asc" {% if sort == 'date_asc' %}checked{% endif %}>
          </label>

          <label class="seg__item {% if sort == 'videos_desc' %}seg__item--active{% endif %}">
            <span class="seg__icon">‚ñ∂Ô∏è</span> {% trans "–ö-—Å—Ç—å –≤—ñ–¥–µ–æ ‚Üì" %}
            <input type="radio" name="sort" value="videos_desc" {% if sort == 'videos_desc' %}checked{% endif %}>
          </label>
          <label class="seg__item {% if sort == 'videos_asc' %}seg__item--active{% endif %}">
            <span class="seg__icon">‚ñ∂Ô∏è</span> {% trans "–ö-—Å—Ç—å –≤—ñ–¥–µ–æ ‚Üë" %}
            <input type="radio" name="sort" value="videos_asc" {% if sort == 'videos_asc' %}checked{% endif %}>
          </label>
        </div>
      </fieldset>

      <div class="flex md:justify-end gap-2">
        <button type="submit" class="btn btn-secondary btn-sm">{% trans "–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏" %}</button>
        <a href="{% url 'library' %}" class="btn btn-sm">{% trans "–°–∫–∏–Ω—É—Ç–∏" %}</a>
      </div>
    </form>
  </article>

  {% if categories %}
    <article class="card">
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-100/70 dark:bg-white/5 text-gray-700 dark:text-gray-200">
            <tr>
              <th class="px-4 py-3 text-left font-semibold">{% trans "–¢–∏–ø" %}</th>
              <th class="px-4 py-3 text-left font-semibold">{% trans "–ú—ñ—Å—Ü–µ" %}</th>
              <th class="px-4 py-3 text-left font-semibold">{% trans "–î–∞—Ç–∞" %}</th>
              <th class="px-4 py-3 text-left font-semibold">{% trans "–í—ñ–¥–µ–æ" %}</th>
              <th class="px-4 py-3 text-right font-semibold">{% trans "–î—ñ—ó" %}</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200 dark:divide-white/10">
            {% for cat in categories %}
              <tr class="hover:bg-gray-50 dark:hover:bg-white/5 transition-colors">
                <td class="px-4 py-3">
                  <span class="inline-flex items-center gap-2">
                    <span class="h-6 w-6 grid place-items-center rounded-md bg-brand-500/10 text-brand-600">üéûÔ∏è</span>
                    <span class="font-medium">{{ cat.get_attempt_type_display }}</span>
                  </span>
                </td>
                <td class="px-4 py-3">
                  <span class="inline-flex items-center gap-1 text-gray-800 dark:text-gray-200">
                    <span>üìç</span><span>{{ cat.place }}</span>
                  </span>
                </td>
                <td class="px-4 py-3">
                  <span class="inline-flex items-center gap-1 text-gray-800 dark:text-gray-200">
                    <span>üìÖ</span><span>{{ cat.date }}</span>
                  </span>
                </td>
                <td class="px-4 py-3">
                  <span class="inline-flex items-center gap-1">
                    <span>‚ñ∂Ô∏è</span><span class="font-medium">{{ cat.videos_count|default:0 }}</span>
                  </span>
                </td>
                <td class="px-4 py-3 text-right">
                  <a href="{% url 'category_detail' cat.id %}" class="btn btn-secondary btn-sm">{% trans "–í—ñ–¥–∫—Ä–∏—Ç–∏" %}</a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {# –ü–∞–≥—ñ–Ω–∞—Ü—ñ—è #}
      {% if categories.paginator %}
        <nav class="card-body pt-4 flex items-center justify-center gap-2">
          {% with qs='attempt_type='|add:filter_attempt_type|urlencode|add:'&sort='|add:sort|urlencode %}
            {% if categories.has_previous %}
              <a class="btn btn-sm" href="?page=1&{{ qs }}">¬´ {% trans "–ü–µ—Ä—à–∞" %}</a>
              <a class="btn btn-sm" href="?page={{ categories.previous_page_number }}&{{ qs }}">‚Äπ {% trans "–ù–∞–∑–∞–¥" %}</a>
            {% else %}
              <span class="btn btn-sm opacity-50 pointer-events-none">¬´ {% trans "–ü–µ—Ä—à–∞" %}</span>
              <span class="btn btn-sm opacity-50 pointer-events-none">‚Äπ {% trans "–ù–∞–∑–∞–¥" %}</span>
            {% endif %}

            <span class="px-3 py-1.5 rounded border border-gray-200 dark:border-white/10 bg-white/70 dark:bg-white/10">
              {% blocktrans with page=categories.number pages=categories.paginator.num_pages %}–°—Ç–æ—Ä. {{ page }} –∑ {{ pages }}{% endblocktrans %}
            </span>

            {% if categories.has_next %}
              <a class="btn btn-sm" href="?page={{ categories.next_page_number }}&{{ qs }}">{% trans "–í–ø–µ—Ä–µ–¥" %} ‚Ä∫</a>
              <a class="btn btn-sm" href="?page={{ categories.paginator.num_pages }}&{{ qs }}">{% trans "–û—Å—Ç–∞–Ω–Ω—è" %} ¬ª</a>
            {% else %}
              <span class="btn btn-sm opacity-50 pointer-events-none">{% trans "–í–ø–µ—Ä–µ–¥" %} ‚Ä∫</span>
              <span class="btn btn-sm opacity-50 pointer-events-none">{% trans "–û—Å—Ç–∞–Ω–Ω—è" %} ¬ª</span>
            {% endif %}
          {% endwith %}
        </nav>
      {% endif %}
    </article>
  {% else %}
    <article class="card">
      <div class="card-body">
        <p class="text-gray-600 dark:text-gray-300 italic">{% trans "–ù–µ–º–∞—î –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –∫–∞—Ç–µ–≥–æ—Ä—ñ–π –∞–±–æ –≤—ñ–¥–µ–æ." %}</p>
      </div>
    </article>
  {% endif %}

<script>
  // –ê–≤—Ç–æ-submit –ø—Ä–∏ –∫–ª—ñ–∫—É –Ω–∞ –ø—ñ–≥—É–ª–∫–∏ + –ø—ñ–¥—Å–≤—ñ—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω–∏—Ö
  (function(){
    const form = document.getElementById('lib-filters');
    const segs = [document.getElementById('seg-type'), document.getElementById('seg-sort')];

    function updateActive(container){
      if (!container) return;
      container.querySelectorAll('.seg__item').forEach(l => l.classList.remove('seg__item--active'));
      const checked = container.querySelector('input:checked');
      if (checked) checked.closest('.seg__item')?.classList.add('seg__item--active');
    }

    segs.forEach(seg => {
      if (!seg) return;
      seg.addEventListener('change', () => {
        updateActive(seg);
        form.submit();
      });
      updateActive(seg);
    });
  })();
</script>

{% endblock %}
