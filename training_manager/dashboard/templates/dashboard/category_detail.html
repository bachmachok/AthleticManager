{# training_manager/dashboard/templates/dashboard/category_detail.html #}
{% extends "dashboard/base.html" %}
{% load static i18n %}

{% block title %}
  {% blocktrans with t=category.get_attempt_type_display p=category.place d=category.date|date:"SHORT_DATE_FORMAT" %}
    –ö–∞—Ç–µ–≥–æ—Ä—ñ—è ‚Äî {{ t }} ({{ p }}, {{ d }})
  {% endblocktrans %}
{% endblock %}

{% block content %}

<style>
  /* ===== Segmented controls (–ø—ñ–≥—É–ª–∫–∏) ===== */
  .seg {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding: 8px;
    border-radius: 12px;
    background: var(--seg-bg, #f8fafc);
  }
  .dark .seg { --seg-bg: rgba(255,255,255,.06); }

  .seg__item {
    position: relative;
    display: inline-flex;
    align-items: center;
    gap: .5rem;
    padding: 10px 14px;
    border-radius: 999px;
    font-size: .9rem;
    font-weight: 600;
    cursor: pointer;
    user-select: none;
    background: #fff;
    border: 1px solid rgba(15,23,42,.08);
    transition: box-shadow .15s ease, transform .06s ease, background .15s ease, color .15s ease;
  }
  .dark .seg__item {
    background: rgba(255,255,255,.04);
    border-color: rgba(255,255,255,.08);
  }
  .seg__item:hover { transform: translateY(-1px); }

  .seg__item input {
    position: absolute;
    inset: 0;
    opacity: 0;
    pointer-events: none;
  }

  .seg__item--active {
    background: #1e49ff;
    color: #fff;
    border-color: transparent;
    box-shadow: 0 6px 18px rgba(30,73,255,.35);
  }
  .seg__item--disabled {
    opacity: .5;
    pointer-events: none;
  }

  .seg__icon {
    font-size: 1rem;
    line-height: 1;
  }

  .filters-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 14px;
  }
  @media (min-width: 860px) {
    .filters-grid {
      grid-template-columns: 1fr 2fr auto;
      align-items: center;
    }
  }
</style>

  <div class="flex items-center justify-between mb-6">
    <h1 class="text-2xl md:text-3xl font-semibold tracking-tight">
      üóÇÔ∏è {% blocktrans with t=category.get_attempt_type_display p=category.place d=category.date|date:"SHORT_DATE_FORMAT" %}{{ t }} ‚Äî {{ p }} ‚Äî {{ d }}{% endblocktrans %}
    </h1>
    <a href="{% url 'library' %}" class="btn">‚¨ÖÔ∏è {% trans "–î–æ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏" %}</a>
  </div>

  <article class="card mb-6">
    <form id="filters-form" method="get" class="card-body filters-grid">

      {# –î–∏—Å—Ü–∏–ø–ª—ñ–Ω–∞ —è–∫ —Å–µ–≥–º–µ–Ω—Ç–Ω—ñ –ø—ñ–≥—É–ª–∫–∏ #}
      <fieldset>
        <legend class="mb-2 text-sm font-medium text-gray-700 dark:text-gray-200">{% trans "–î–∏—Å—Ü–∏–ø–ª—ñ–Ω–∞" %}</legend>
        <div class="seg" id="seg-event">
          {# –∑–Ω–∞—á–µ–Ω–Ω—è –±–µ—Ä–µ–º–æ –∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É filter_event #}
          <label class="seg__item {% if not filter_event %}seg__item--active{% endif %}">
            <span class="seg__icon">‚ú®</span> {% trans "–£—Å—ñ" %}
            <input type="radio" name="event" value="" {% if not filter_event %}checked{% endif %}>
          </label>

          <label class="seg__item {% if filter_event == 'run' %}seg__item--active{% endif %}">
            <span class="seg__icon">üèÉ</span> {% trans "–ë—ñ–≥" %}
            <input type="radio" name="event" value="run" {% if filter_event == 'run' %}checked{% endif %}>
          </label>

          <label class="seg__item {% if filter_event == 'jump' %}seg__item--active{% endif %}">
            <span class="seg__icon">ü¶ò</span> {% trans "–°—Ç—Ä–∏–±–∫–∏" %}
            <input type="radio" name="event" value="jump" {% if filter_event == 'jump' %}checked{% endif %}>
          </label>

          <label class="seg__item {% if filter_event == 'throw' %}seg__item--active{% endif %}">
            <span class="seg__icon">ü•è</span> {% trans "–ú–µ—Ç–∞–Ω–Ω—è/–®—Ç–æ–≤—Ö–∞–Ω–Ω—è" %}
            <input type="radio" name="event" value="throw" {% if filter_event == 'throw' %}checked{% endif %}>
          </label>
        </div>
      </fieldset>

      {# –°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è —è–∫ —Å–µ–≥–º–µ–Ω—Ç–Ω—ñ –ø—ñ–≥—É–ª–∫–∏ (–±–µ–∑ "–º—ñ—Å—Ü—è") #}
      <fieldset>
        <legend class="mb-2 text-sm font-medium text-gray-700 dark:text-gray-200">{% trans "–°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è" %}</legend>
        <div class="seg" id="seg-sort">
          <label class="seg__item {% if sort == 'attempt_asc' %}seg__item--active{% endif %}">
            <span class="seg__icon">#‚Üë</span> {% trans "‚Ññ —Å–ø—Ä–æ–±–∏" %}
            <input type="radio" name="sort" value="attempt_asc" {% if sort == 'attempt_asc' %}checked{% endif %}>
          </label>
          <label class="seg__item {% if sort == 'attempt_desc' %}seg__item--active{% endif %}">
            <span class="seg__icon">#‚Üì</span> {% trans "‚Ññ —Å–ø—Ä–æ–±–∏" %}
            <input type="radio" name="sort" value="attempt_desc" {% if sort == 'attempt_desc' %}checked{% endif %}>
          </label>

          <label class="seg__item {% if sort == 'time_asc' %}seg__item--active{% endif %}">
            <span class="seg__icon">‚è±‚Üë</span> {% trans "–ß–∞—Å" %}
            <input type="radio" name="sort" value="time_asc" {% if sort == 'time_asc' %}checked{% endif %}>
          </label>
          <label class="seg__item {% if sort == 'time_desc' %}seg__item--active{% endif %}">
            <span class="seg__icon">‚è±‚Üì</span> {% trans "–ß–∞—Å" %}
            <input type="radio" name="sort" value="time_desc" {% if sort == 'time_desc' %}checked{% endif %}>
          </label>

          {% with has_event=filter_event|yesno:"1,," %}
            <label class="seg__item {% if sort == 'result_best' %}seg__item--active{% endif %} {% if not filter_event %}seg__item--disabled{% endif %}">
              <span class="seg__icon">‚≠ê</span> {% trans "–†–µ–∑—É–ª—å—Ç–∞—Ç (–∫—Ä–∞—â–∏–π)" %}
              <input type="radio" name="sort" value="result_best" {% if sort == 'result_best' %}checked{% endif %} {% if not filter_event %}disabled{% endif %}>
            </label>
            <label class="seg__item {% if sort == 'result_worst' %}seg__item--active{% endif %} {% if not filter_event %}seg__item--disabled{% endif %}">
              <span class="seg__icon">‚¨á</span> {% trans "–†–µ–∑—É–ª—å—Ç–∞—Ç (–≥—ñ—Ä—à–∏–π)" %}
              <input type="radio" name="sort" value="result_worst" {% if sort == 'result_worst' %}checked{% endif %} {% if not filter_event %}disabled{% endif %}>
            </label>
          {% endwith %}

          <label class="seg__item {% if sort == 'created_desc' %}seg__item--active{% endif %}">
            <span class="seg__icon">üÜï</span> {% trans "–î–æ–¥–∞–Ω—ñ ‚Äî –Ω–æ–≤—ñ—à—ñ" %}
            <input type="radio" name="sort" value="created_desc" {% if sort == 'created_desc' %}checked{% endif %}>
          </label>
          <label class="seg__item {% if sort == 'created_asc' %}seg__item--active{% endif %}">
            <span class="seg__icon">üìÖ</span> {% trans "–î–æ–¥–∞–Ω—ñ ‚Äî —Å—Ç–∞—Ä—ñ—à—ñ" %}
            <input type="radio" name="sort" value="created_asc" {% if sort == 'created_asc' %}checked{% endif %}>
          </label>
        </div>

        {% if not filter_event and sort == 'result_best' or not filter_event and sort == 'result_worst' %}
          <p class="mt-2 text-xs text-amber-600 dark:text-amber-400">
            {% trans "–©–æ–± —É–≤—ñ–º–∫–Ω—É—Ç–∏ —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è –∑–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º, —Å–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –¥–∏—Å—Ü–∏–ø–ª—ñ–Ω—É." %}
          </p>
        {% endif %}
      </fieldset>

      <div class="flex md:justify-end gap-2">
        <button type="submit" class="btn btn-primary btn-sm">{% trans "–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏" %}</button>
        <a href="{% url 'category_detail' category.id %}" class="btn btn-sm">{% trans "–°–∫–∏–Ω—É—Ç–∏" %}</a>
      </div>
    </form>
  </article>

  {% if videos %}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {% for video in videos %}
        <article class="card overflow-hidden">
          <div class="card-body pb-0">
            <div class="flex items-center justify-between mb-2">
              <span class="inline-flex items-center rounded-full bg-gray-200 px-2.5 py-1 text-xs font-medium text-gray-800 dark:bg-white/10 dark:text-gray-200">
                {{ video.get_event_type_display }}
              </span>
              <span class="text-xs text-gray-500 dark:text-gray-400">
                {% blocktrans with n=video.attempt_number %}–°–ø—Ä–æ–±–∞ ‚Ññ {{ n }}{% endblocktrans %}
              </span>
            </div>

            <ul class="text-sm space-y-1">
              <li>
                <span class="text-gray-500 dark:text-gray-400">üéØ {% trans "–†–µ–∑—É–ª—å—Ç–∞—Ç:" %}</span>
                {{ video.result }}
                <span class="ml-1 text-xs text-gray-500">
                  {% if video.event_type == 'run' %}{% trans "—Å" %}{% else %}{% trans "–º" %}{% endif %}
                </span>
              </li>
              <li>
                <span class="text-gray-500 dark:text-gray-400">‚è±Ô∏è {% trans "–ß–∞—Å:" %}</span>
                {{ video.time|default:"‚Äî" }}
              </li>
            </ul>
          </div>

          <div class="p-4 pt-3">
            <video controls class="w-full rounded-lg ring-1 ring-gray-200 dark:ring-white/10">
              <source src="{{ video.video.url }}" type="video/mp4">
            </video>
            <div class="mt-3 flex gap-2">
              <a href="{% url 'annotate_video' video.id %}?mode=view&from=category&cat={{ category.id }}"
                 class="btn btn-primary">{% trans "–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏" %}</a>
              <a href="{% url 'annotate_video' video.id %}?mode=edit&from=category&cat={{ category.id }}"
                 class="btn">{% trans "–ê–Ω–æ—Ç—É–≤–∞—Ç–∏" %}</a>
            </div>
          </div>
        </article>
      {% endfor %}
    </div>

    {% if videos.paginator %}
      <nav class="card mt-6">
        <div class="card-body flex items-center justify-center gap-2">
          {% with ev='event='|add:filter_event|urlencode so='sort='|add:sort|urlencode %}
            {% if videos.has_previous %}
              <a class="btn btn-sm" href="?page=1&{{ ev }}&{{ so }}">¬´ {% trans "–ü–µ—Ä—à–∞" %}</a>
              <a class="btn btn-sm" href="?page={{ videos.previous_page_number }}&{{ ev }}&{{ so }}">‚Äπ {% trans "–ù–∞–∑–∞–¥" %}</a>
            {% else %}
              <span class="btn btn-sm opacity-50 pointer-events-none">¬´ {% trans "–ü–µ—Ä—à–∞" %}</span>
              <span class="btn btn-sm opacity-50 pointer-events-none">‚Äπ {% trans "–ù–∞–∑–∞–¥" %}</span>
            {% endif %}

            <span class="px-3 py-1.5 rounded border border-gray-200 dark:border-white/10 bg-white/70 dark:bg-white/10">
              {% blocktrans with n=videos.number total=videos.paginator.num_pages %}–°—Ç–æ—Ä. <strong>{{ n }}</strong> –∑ {{ total }}{% endblocktrans %}
            </span>

            {% if videos.has_next %}
              <a class="btn btn-sm" href="?page={{ videos.next_page_number }}&{{ ev }}&{{ so }}">{% trans "–í–ø–µ—Ä–µ–¥" %} ‚Ä∫</a>
              <a class="btn btn-sm" href="?page={{ videos.paginator.num_pages }}&{{ ev }}&{{ so }}">{% trans "–û—Å—Ç–∞–Ω–Ω—è" %} ¬ª</a>
            {% else %}
              <span class="btn btn-sm opacity-50 pointer-events-none">{% trans "–í–ø–µ—Ä–µ–¥" %} ‚Ä∫</span>
              <span class="btn btn-sm opacity-50 pointer-events-none">{% trans "–û—Å—Ç–∞–Ω–Ω—è" %} ¬ª</span>
            {% endif %}
          {% endwith %}
        </div>
      </nav>
    {% endif %}
  {% else %}
    <article class="card">
      <div class="card-body">
        <p class="text-gray-600 dark:text-gray-300 italic">
          {% trans "–£ —Ü—ñ–π –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –Ω–µ–º–∞—î –≤—ñ–¥–µ–æ –∑–∞ –æ–±—Ä–∞–Ω–∏–º–∏ —Ñ—ñ–ª—å—Ç—Ä–∞–º–∏." %}
        </p>
      </div>
    </article>
  {% endif %}

<script>
  // –ê–≤—Ç–æ-submit –ø—Ä–∏ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—ñ –Ω–∞ –ø—ñ–≥—É–ª–∫–∏ + —Ä–æ–∑—É–º–Ω–µ –≤–º–∏–∫–∞–Ω–Ω—è/–≤–∏–º–∏–∫–∞–Ω–Ω—è —Å–æ—Ä—Ç—É "—Ä–µ–∑—É–ª—å—Ç–∞—Ç"
  (function(){
    const form = document.getElementById('filters-form');

    const eventWrap = document.getElementById('seg-event');
    const sortWrap  = document.getElementById('seg-sort');

    function updateActive(container){
      container.querySelectorAll('.seg__item').forEach(l => l.classList.remove('seg__item--active'));
      const checked = container.querySelector('input:checked');
      if (checked) checked.closest('.seg__item')?.classList.add('seg__item--active');
    }

    function toggleResultSort(){
      const eventChecked = eventWrap.querySelector('input[name="event"]:checked');
      const hasDiscipline = eventChecked && eventChecked.value !== '';
      sortWrap.querySelectorAll('input[value="result_best"], input[value="result_worst"]').forEach(inp => {
        const label = inp.closest('.seg__item');
        if (hasDiscipline) {
          inp.disabled = false;
          label.classList.remove('seg__item--disabled');
        } else {
          inp.disabled = true;
          label.classList.remove('seg__item--active');
          label.classList.add('seg__item--disabled');
          // —è–∫—â–æ –±—É–≤ –æ–±—Ä–∞–Ω–∏–π ¬´result_*¬ª, –∑–Ω—ñ–º–µ–º–æ –≤–∏–±—ñ—Ä
          if (inp.checked) {
            inp.checked = false;
            // –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –ø–æ–≤–µ—Ä–Ω–µ–º–æ –Ω–∞ created_desc
            const fallback = sortWrap.querySelector('input[value="created_desc"]');
            if (fallback) fallback.checked = true;
          }
        }
      });
      updateActive(sortWrap);
    }

    eventWrap.addEventListener('change', () => {
      updateActive(eventWrap);
      toggleResultSort();
      form.submit();
    });

    sortWrap.addEventListener('change', () => {
      updateActive(sortWrap);
      form.submit();
    });

    // init
    updateActive(eventWrap);
    updateActive(sortWrap);
    toggleResultSort();
  })();
</script>

{% endblock %}
